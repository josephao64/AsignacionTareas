<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cierre de Mes - Reporte de Pedidos de Cajas y Pagos de Cajas</title>
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- jsPDF, html2canvas y html2pdf.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        /* Estilos Específicos para la Página de Cierre de Mes */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        h1, h2, h3 {
            color: #004d40;
            text-align: center;
        }

        .report-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            justify-content: center;
        }

        .report-controls label {
            margin-right: 5px;
            font-weight: bold;
        }

        .report-controls input,
        .report-controls select {
            padding: 5px;
            font-size: 14px;
        }

        .report-controls button {
            padding: 8px 12px;
            font-size: 14px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .report-controls button:disabled {
            background-color: #b2dfdb;
            cursor: not-allowed;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .report-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .general-summary,
        .all-orders,
        .all-payments,
        .sucursal-report,
        .empresa-summary {
            margin-bottom: 30px;
            page-break-inside: avoid; /* Evitar saltos de página dentro de estos bloques */
        }

        .general-summary {
            background-color: #e0f7fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #00796b;
        }

        .general-summary h3 {
            margin-bottom: 10px;
            color: #004d40;
        }

        .general-summary p {
            font-size: 16px;
            margin-bottom: 5px;
            color: #00695c;
        }

        .general-summary strong {
            color: #004d40;
        }

        .all-orders, .all-payments {
            background-color: #fffde7;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #fbc02d;
        }

        .all-orders h3, .all-payments h3 {
            margin-bottom: 10px;
            color: #f57f17;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            table-layout: fixed; /* Control de ancho fijo */
            word-wrap: break-word; /* Ajuste de palabras largas */
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px; /* Tamaño de fuente reducido */
        }

        th {
            background-color: #f57f17;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #fff9c4;
        }

        tr:hover {
            background-color: #fff59d;
        }

        .summary-report {
            margin-top: 10px;
            font-size: 14px;
            color: #004d40;
        }

        .summary-report.total-section {
            font-weight: bold;
            color: #f57f17;
        }

        /* Estilos para la Exportación en PDF */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
            }
            .export-buttons {
                display: none;
            }
        }

        /* Responsive */
        @media (max-width: 800px) {
            .report-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        /* Estilos para los Reportes por Sucursal */
        .sucursal-report h2 {
            color: #2e7d32;
        }

        .sucursal-report h3 {
            color: #388e3c;
        }

        /* Estilos para los Reportes por Empresa */
        .empresa-summary {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #388e3c;
        }

        .empresa-summary h3 {
            margin-bottom: 10px;
            color: #1b5e20;
        }

        .empresa-summary p {
            font-size: 16px;
            margin-bottom: 5px;
            color: #2e7d32;
        }

        .empresa-summary strong {
            color: #1b5e20;
        }

        /* Clase para forzar salto de página en PDF */
        .sucursal-report, .empresa-summary {
            break-inside: avoid; /* Propiedad moderna para evitar saltos dentro */
            page-break-inside: avoid; /* Propiedad para mayor compatibilidad */
        }

        /* Forzar que cada reporte de sucursal inicie en una nueva página */
        .sucursal-report {
            break-before: page; /* Propiedad moderna */
            page-break-before: always; /* Propiedad para mayor compatibilidad */
        }

        .sucursal-report:first-child {
            break-before: auto;
            page-break-before: auto;
        }
    </style>
</head>
<body>
    <!-- Contenedor Principal de la Página de Cierre de Mes -->
    <div class="container" id="cierreMesApp">
        <h1>Cierre de Mes - Reporte de Pedidos de Cajas y Pagos de Cajas</h1>

        <!-- Controles para Seleccionar Mes y Sucursal -->
        <div class="report-controls">
            <div>
                <label for="reportMes">Selecciona el Mes:</label>
                <input type="month" id="reportMes">
            </div>

            <div>
                <label for="reportSucursal">Selecciona la Sucursal:</label>
                <select id="reportSucursal">
                    <option value="">Todas las Sucursales</option>
                    <option value="jalapa">Jalapa</option>
                    <option value="poptun">Poptún</option>
                    <option value="zacapa">Zacapa</option>
                    <option value="santa elena">Santa Elena</option>
                    <option value="pinula">Pinula</option>
                    <option value="eskala">Eskala</option>
                </select>
            </div>

            <button id="generarReporteBtn">Generar Reporte</button>
            <div class="export-buttons">
                <button id="exportarReporteCSVBtn" disabled>Exportar a CSV</button>
                <button id="exportarReportePDFBtn" disabled>Exportar a PDF</button>
            </div>
        </div>

        <!-- Área para Mostrar el Reporte -->
        <div class="report-content" id="reportContent">
            <!-- Las secciones del reporte se generarán aquí dinámicamente -->
        </div>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Script para Manejar el Reporte de Cierre de Mes -->
    <script>
        // Datos iniciales de Sucursales (Debe coincidir con los de registro_pedidos.html)
        const data = [
            { Empresa: "VIPIZZA", Sucursal: "jalapa", PizzaMensual: 3462, FingersMensual: 356 },
            { Empresa: "VIPIZZA", Sucursal: "poptun", PizzaMensual: 3992, FingersMensual: 312 },
            { Empresa: "VIPIZZA", Sucursal: "zacapa", PizzaMensual: 5706, FingersMensual: 611 },
            { Empresa: "AMERICAN PIZZA", Sucursal: "santa elena", PizzaMensual: 5893, FingersMensual: 287 },
            { Empresa: "AMERICAN PIZZA", Sucursal: "pinula", PizzaMensual: 4639, FingersMensual: 379 },
            { Empresa: "AMERICAN PIZZA", Sucursal: "eskala", PizzaMensual: 2460, FingersMensual: 211 },
        ];

        // Inicialización de datos desde localStorage
        let pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
        let pagos = JSON.parse(localStorage.getItem('pagos')) || [];

        // Asegurarse de que cada pago tenga un campo 'mes'
        function limpiarPagos() {
            let actualizados = false;
            pagos = pagos.map(pago => {
                if (!pago.mes) {
                    if (pago.fechaPago) {
                        const [year, month] = pago.fechaPago.split('-');
                        pago.mes = `${year}-${month}`;
                        actualizados = true;
                    } else {
                        pago.mes = 'Desconocido';
                        actualizados = true;
                    }
                }
                return pago;
            });
            if (actualizados) {
                localStorage.setItem('pagos', JSON.stringify(pagos));
            }
        }

        // Llamar a la función de limpieza al cargar la página
        limpiarPagos();

        // Elementos del DOM
        const reportMesInput = document.getElementById('reportMes');
        const reportSucursalSelect = document.getElementById('reportSucursal');
        const generarReporteBtn = document.getElementById('generarReporteBtn');
        const exportarReporteCSVBtn = document.getElementById('exportarReporteCSVBtn');
        const exportarReportePDFBtn = document.getElementById('exportarReportePDFBtn');
        const reportContent = document.getElementById('reportContent');

        // Crear un mapeo de Sucursal a Empresa para uso posterior
        const sucursalToEmpresaMap = {};
        data.forEach(item => {
            sucursalToEmpresaMap[item.Sucursal.toLowerCase()] = item.Empresa;
        });

        // Función para capitalizar la primera letra
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Función para eliminar iframes dentro de un elemento dado
        function eliminarIframes(element) {
            const iframes = element.querySelectorAll('iframe');
            iframes.forEach(iframe => iframe.remove());
        }

        // Función para generar el reporte
        function generarReporte() {
            const mesSeleccionado = reportMesInput.value; // Formato 'YYYY-MM'
            const sucursalSeleccionada = reportSucursalSelect.value.toLowerCase();

            if (!mesSeleccionado) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Por favor, selecciona un Mes para generar el reporte.',
                });
                return;
            }

            // Extraer mes y año para el título
            const [year, month] = mesSeleccionado.split('-');
            const fechaTitulo = new Date(year, month - 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' });

            // Filtrar Pedidos por Mes y Sucursal
            let pedidosFiltrados = pedidos.filter(pedido => {
                const pedidoDate = new Date(pedido.Fecha);
                const pedidoYear = pedidoDate.getFullYear();
                const pedidoMonth = pedidoDate.getMonth() + 1; // Los meses en JS van de 0-11
                const mesCoincide = (pedidoYear === parseInt(year)) && (pedidoMonth === parseInt(month));
                const sucursalCoincide = sucursalSeleccionada ? (pedido.Sucursal.toLowerCase() === sucursalSeleccionada) : true;
                return mesCoincide && sucursalCoincide;
            });

            // Filtrar Pagos asociados al Mes Seleccionado y Sucursal
            let pagosFiltrados = pagos.filter(pago => {
                const pagoMes = pago.mes;
                const pagoSucursal = pago.Sucursal.toLowerCase();
                const mesCoincide = pagoMes === mesSeleccionado;
                const sucursalCoincide = sucursalSeleccionada ? (pagoSucursal === sucursalSeleccionada) : true;
                return mesCoincide && sucursalCoincide;
            });

            // Obtener la lista de sucursales a reportar
            let sucursalesReport = [];
            if (sucursalSeleccionada) {
                sucursalesReport = [sucursalSeleccionada];
            } else {
                // Obtener todas las sucursales únicas presentes en los pedidos y pagos filtrados
                const sucursalesPedidos = pedidosFiltrados.map(p => p.Sucursal.toLowerCase());
                const sucursalesPagos = pagosFiltrados.map(p => p.Sucursal.toLowerCase());
                const todasSucursales = [...new Set([...sucursalesPedidos, ...sucursalesPagos])];
                sucursalesReport = todasSucursales;
            }

            // Calcular Totales Generales
            const totalPedidosGenerales = pedidosFiltrados.reduce((sum, pedido) => sum + pedido.PrecioTotal, 0);
            const totalPagadoGenerales = pagosFiltrados.reduce((sum, pago) => sum + pago.precioTotalPagado, 0);
            const totalPendienteGenerales = totalPedidosGenerales - totalPagadoGenerales > 0 ? totalPedidosGenerales - totalPagadoGenerales : 0;
            const saldoGenerales = totalPagadoGenerales - totalPedidosGenerales > 0 ? totalPagadoGenerales - totalPedidosGenerales : 0;

            // Calcular Resumen de Cajas por Sucursal
            const cajasPorSucursal = {};
            sucursalesReport.forEach(sucursal => {
                const pedidosSucursal = pedidosFiltrados.filter(p => p.Sucursal.toLowerCase() === sucursal);
                const pizzaCount = pedidosSucursal.filter(p => p.TipoCaja.toLowerCase() === 'pizza').reduce((sum, p) => sum + p.Cantidad, 0);
                const fingersCount = pedidosSucursal.filter(p => p.TipoCaja.toLowerCase() === 'fingers').reduce((sum, p) => sum + p.Cantidad, 0);
                cajasPorSucursal[sucursal] = { pizza: pizzaCount, fingers: fingersCount };
            });

            // Calcular Totales de Pizza y Fingers para todas las Sucursales
            let totalPizzaSucursal = 0;
            let totalFingersSucursal = 0;
            sucursalesReport.forEach(sucursal => {
                totalPizzaSucursal += cajasPorSucursal[sucursal].pizza;
                totalFingersSucursal += cajasPorSucursal[sucursal].fingers;
            });

            // Calcular Resumen de Cajas por Empresa
            const cajasPorEmpresa = {};
            // Iterar sobre cada pedido filtrado y acumular por empresa usando el mapeo Sucursal -> Empresa
            pedidosFiltrados.forEach(pedido => {
                const empresa = sucursalToEmpresaMap[pedido.Sucursal.toLowerCase()] || 'Desconocida';
                if (!cajasPorEmpresa[empresa]) {
                    cajasPorEmpresa[empresa] = { pizza: 0, fingers: 0 };
                }
                if (pedido.TipoCaja.toLowerCase() === 'pizza') {
                    cajasPorEmpresa[empresa].pizza += pedido.Cantidad;
                } else if (pedido.TipoCaja.toLowerCase() === 'fingers') {
                    cajasPorEmpresa[empresa].fingers += pedido.Cantidad;
                }
            });

            // Calcular Totales de Pizza y Fingers para todas las Empresas
            let totalPizzaEmpresa = 0;
            let totalFingersEmpresa = 0;
            Object.keys(cajasPorEmpresa).forEach(empresa => {
                totalPizzaEmpresa += cajasPorEmpresa[empresa].pizza;
                totalFingersEmpresa += cajasPorEmpresa[empresa].fingers;
            });

            // Generar el reporte por sucursal y empresa
            let reporteHTML = '';

            // Añadir el Título Principal al inicio del reporte (dentro de reportContent)
            reporteHTML += `
                <h2>Reporte de Pedidos de Cajas y Pagos de Cajas - ${fechaTitulo}</h2>
            `;

            // Añadir el Resumen General al inicio del reporte
            reporteHTML += `
                <div class="general-summary">
                    <h3>Resumen General</h3>
                    <p><strong>Total Pedidos:</strong> Q${totalPedidosGenerales.toFixed(2)}</p>
                    <p><strong>Total Pagado:</strong> Q${totalPagadoGenerales.toFixed(2)}</p>
                    <p><strong>Total Pendiente:</strong> Q${totalPendienteGenerales.toFixed(2)}</p>
                    <p><strong>Saldo:</strong> ${saldoGenerales > 0 ? `Q${saldoGenerales.toFixed(2)}` : 'Q0.00'}</p>
                </div>
            `;

            // Añadir Resumen de Cajas por Sucursal
            reporteHTML += `
                <div class="empresa-summary">
                    <h3>Cajas Consumidas por Sucursal</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Sucursal</th>
                                <th>Pizza</th>
                                <th>Fingers</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sucursalesReport.length > 0 ? sucursalesReport.map(sucursal => `
                                <tr>
                                    <td>${capitalizeFirstLetter(sucursal)}</td>
                                    <td>${cajasPorSucursal[sucursal].pizza}</td>
                                    <td>${cajasPorSucursal[sucursal].fingers}</td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="3" style="text-align: center;">No hay datos de sucursales.</td>
                                </tr>
                            `}
                            <!-- Fila de Totales -->
                            ${sucursalesReport.length > 0 ? `
                                <tr>
                                    <td><strong>Total</strong></td>
                                    <td><strong>${totalPizzaSucursal}</strong></td>
                                    <td><strong>${totalFingersSucursal}</strong></td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            `;

            // Añadir Resumen de Cajas por Empresa
            reporteHTML += `
                <div class="empresa-summary">
                    <h3>Cajas Consumidas por Empresa</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Empresa</th>
                                <th>Pizza</th>
                                <th>Fingers</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(cajasPorEmpresa).length > 0 ? Object.keys(cajasPorEmpresa).map(empresa => `
                                <tr>
                                    <td>${empresa}</td>
                                    <td>${cajasPorEmpresa[empresa].pizza}</td>
                                    <td>${cajasPorEmpresa[empresa].fingers}</td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="3" style="text-align: center;">No hay datos de empresas.</td>
                                </tr>
                            `}
                            <!-- Fila de Totales -->
                            ${Object.keys(cajasPorEmpresa).length > 0 ? `
                                <tr>
                                    <td><strong>Total</strong></td>
                                    <td><strong>${totalPizzaEmpresa}</strong></td>
                                    <td><strong>${totalFingersEmpresa}</strong></td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            `;

            // Añadir el Detalle de Todos los Pedidos
            reporteHTML += `
                <div class="all-orders">
                    <h3>Todos los Pedidos</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Sucursal</th>
                                <th>Tipo de Caja</th>
                                <th>Fecha</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario (Q)</th>
                                <th>Precio Total (Q)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pedidosFiltrados.length > 0 ? pedidosFiltrados.map(pedido => `
                                <tr>
                                    <td>${pedido.id}</td>
                                    <td>${capitalizeFirstLetter(pedido.Sucursal)}</td>
                                    <td>${pedido.TipoCaja}</td>
                                    <td>${pedido.Fecha}</td>
                                    <td>${pedido.Cantidad}</td>
                                    <td>Q${pedido.PrecioUnitario.toFixed(2)}</td>
                                    <td>Q${pedido.PrecioTotal.toFixed(2)}</td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="7" style="text-align: center;">No hay pedidos en el mes seleccionado.</td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                    <p class="summary-report total-section"><strong>Total General de Pedidos:</strong> Q${totalPedidosGenerales.toFixed(2)}</p>
                </div>
            `;

            // Añadir el Detalle de Todos los Pagos
            reporteHTML += `
                <div class="all-payments">
                    <h3>Todos los Pagos</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Sucursal</th>
                                <th>Fecha Pago</th>
                                <th>Número de Boleta</th>
                                <th>Total Boleta (Q)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pagosFiltrados.length > 0 ? pagosFiltrados.map(pago => `
                                <tr>
                                    <td>${pago.id}</td>
                                    <td>${capitalizeFirstLetter(pago.Sucursal)}</td>
                                    <td>${pago.fechaPago}</td>
                                    <td>${pago.boletaPago}</td>
                                    <td>Q${pago.precioTotalPagado.toFixed(2)}</td>
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="5" style="text-align: center;">No hay pagos asociados al mes seleccionado.</td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                    <p class="summary-report total-section"><strong>Total General de Pagos:</strong> Q${totalPagadoGenerales.toFixed(2)}</p>
                </div>
            `;

            // Generar Reporte por Sucursal
            sucursalesReport.forEach((sucursal, index) => {
                const empresa = sucursalToEmpresaMap[sucursal] || 'Desconocida';
                const sucursalNombre = capitalizeFirstLetter(sucursal);

                // Filtrar pedidos y pagos para esta sucursal
                const pedidosSucursal = pedidosFiltrados.filter(p => p.Sucursal.toLowerCase() === sucursal);
                const pagosSucursal = pagosFiltrados.filter(p => p.Sucursal.toLowerCase() === sucursal);

                // Calcular Totales
                const totalPedidos = pedidosSucursal.reduce((sum, pedido) => sum + pedido.PrecioTotal, 0);
                const totalPagado = pagosSucursal.reduce((sum, pago) => sum + pago.precioTotalPagado, 0);
                const totalPendiente = totalPedidos - totalPagado > 0 ? totalPedidos - totalPagado : 0;
                const saldo = totalPagado - totalPedidos > 0 ? totalPagado - totalPedidos : 0;

                // Calcular Resumen de Cajas por Tipo de Caja en esta sucursal
                const cajasPorTipo = {
                    pizza: pedidosSucursal.filter(p => p.TipoCaja.toLowerCase() === 'pizza').reduce((sum, p) => sum + p.Cantidad, 0),
                    fingers: pedidosSucursal.filter(p => p.TipoCaja.toLowerCase() === 'fingers').reduce((sum, p) => sum + p.Cantidad, 0)
                };

                // Generar HTML para esta sucursal
                reporteHTML += `
                    <div class="sucursal-report">
                        <h2>Reporte - ${sucursalNombre} (${empresa})</h2>
                        
                        <h3>Resumen de Cajas Consumidas</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Pizza</th>
                                    <th>Fingers</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${cajasPorTipo.pizza}</td>
                                    <td>${cajasPorTipo.fingers}</td>
                                </tr>
                            </tbody>
                        </table>

                        <h3>Pedidos</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo de Caja</th>
                                    <th>Fecha</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario (Q)</th>
                                    <th>Precio Total (Q)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pedidosSucursal.length > 0 ? pedidosSucursal.map(pedido => `
                                    <tr>
                                        <td>${pedido.id}</td>
                                        <td>${pedido.TipoCaja}</td>
                                        <td>${pedido.Fecha}</td>
                                        <td>${pedido.Cantidad}</td>
                                        <td>Q${pedido.PrecioUnitario.toFixed(2)}</td>
                                        <td>Q${pedido.PrecioTotal.toFixed(2)}</td>
                                    </tr>
                                `).join('') : `
                                    <tr>
                                        <td colspan="6" style="text-align: center;">No hay pedidos para esta sucursal en el mes seleccionado.</td>
                                    </tr>
                                `}
                            </tbody>
                        </table>

                        <h3>Pagos</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha Pago</th>
                                    <th>Número de Boleta</th>
                                    <th>Total Boleta (Q)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pagosSucursal.length > 0 ? pagosSucursal.map(pago => `
                                    <tr>
                                        <td>${pago.id}</td>
                                        <td>${pago.fechaPago}</td>
                                        <td>${pago.boletaPago}</td>
                                        <td>Q${pago.precioTotalPagado.toFixed(2)}</td>
                                    </tr>
                                `).join('') : `
                                    <tr>
                                        <td colspan="4" style="text-align: center;">No hay pagos para esta sucursal en el mes seleccionado.</td>
                                    </tr>
                                `}
                            </tbody>
                        </table>

                        <h3>Resumen</h3>
                        <p class="summary-report"><strong>Total Pedidos:</strong> Q${totalPedidos.toFixed(2)}</p>
                        <p class="summary-report"><strong>Total Pagado:</strong> Q${totalPagado.toFixed(2)}</p>
                        <p class="summary-report"><strong>Total Pendiente:</strong> Q${totalPendiente.toFixed(2)}</p>
                        <p class="summary-report"><strong>Saldo:</strong> ${saldo > 0 ? `Q${saldo.toFixed(2)}` : 'Q0.00'}</p>
                        <hr>
                    </div>
                `;
            });

            // Mostrar el reporte en el DOM
            reportContent.innerHTML = reporteHTML;

            // Verificar y eliminar cualquier iframe dentro del reporte
            eliminarIframes(reportContent);

            // Habilitar los botones de exportar si hay datos
            if (pedidosFiltrados.length > 0 || pagosFiltrados.length > 0) {
                exportarReporteCSVBtn.disabled = false;
                exportarReportePDFBtn.disabled = false;
            } else {
                exportarReporteCSVBtn.disabled = true;
                exportarReportePDFBtn.disabled = true;
            }
        }

        // Función para exportar el reporte a CSV
        function exportarCSV() {
            const mesSeleccionado = reportMesInput.value; // Formato 'YYYY-MM'
            const sucursalSeleccionada = reportSucursalSelect.value.toLowerCase();

            if (!mesSeleccionado) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Por favor, selecciona un Mes para exportar el reporte.',
                });
                return;
            }

            // Filtrar Pedidos por Mes y Sucursal
            let pedidosFiltrados = pedidos.filter(pedido => {
                const pedidoDate = new Date(pedido.Fecha);
                const [year, month] = mesSeleccionado.split('-').map(num => parseInt(num));
                const pedidoYear = pedidoDate.getFullYear();
                const pedidoMonth = pedidoDate.getMonth() + 1; // Los meses en JS van de 0-11
                const mesCoincide = (pedidoYear === year) && (pedidoMonth === month);
                const sucursalCoincide = sucursalSeleccionada ? (pedido.Sucursal.toLowerCase() === sucursalSeleccionada) : true;
                return mesCoincide && sucursalCoincide;
            });

            // Filtrar Pagos asociados al Mes Seleccionado y Sucursal
            let pagosFiltrados = pagos.filter(pago => {
                const pagoMes = pago.mes;
                const pagoSucursal = pago.Sucursal.toLowerCase();
                const mesCoincide = pagoMes === mesSeleccionado;
                const sucursalCoincide = sucursalSeleccionada ? (pagoSucursal === sucursalSeleccionada) : true;
                return mesCoincide && sucursalCoincide;
            });

            // Obtener la lista de sucursales a reportar
            let sucursalesReport = [];
            if (sucursalSeleccionada) {
                sucursalesReport = [sucursalSeleccionada];
            } else {
                // Obtener todas las sucursales únicas presentes en los pedidos y pagos filtrados
                const sucursalesPedidos = pedidosFiltrados.map(p => p.Sucursal.toLowerCase());
                const sucursalesPagos = pagosFiltrados.map(p => p.Sucursal.toLowerCase());
                const todasSucursales = [...new Set([...sucursalesPedidos, ...sucursalesPagos])];
                sucursalesReport = todasSucursales;
            }

            // Calcular Totales Generales
            const totalPedidosGenerales = pedidosFiltrados.reduce((sum, pedido) => sum + pedido.PrecioTotal, 0);
            const totalPagadoGenerales = pagosFiltrados.reduce((sum, pago) => sum + pago.precioTotalPagado, 0);
            const totalPendienteGenerales = totalPedidosGenerales - totalPagadoGenerales > 0 ? totalPedidosGenerales - totalPagadoGenerales : 0;
            const saldoGenerales = totalPagadoGenerales - totalPedidosGenerales > 0 ? totalPagadoGenerales - totalPedidosGenerales : 0;

            // Calcular Resumen de Cajas por Sucursal
            const cajasPorSucursal = {};
            sucursalesReport.forEach(sucursal => {
                const pedidosSucursal = pedidosFiltrados.filter(p => p.Sucursal.toLowerCase() === sucursal);
                const pizzaCount = pedidosSucursal.filter(p => p.TipoCaja.toLowerCase() === 'pizza').reduce((sum, p) => sum + p.Cantidad, 0);
                const fingersCount = pedidosSucursal.filter(p => p.TipoCaja.toLowerCase() === 'fingers').reduce((sum, p) => sum + p.Cantidad, 0);
                cajasPorSucursal[sucursal] = { pizza: pizzaCount, fingers: fingersCount };
            });

            // Calcular Totales de Pizza y Fingers para todas las Sucursales
            let totalPizzaSucursal = 0;
            let totalFingersSucursal = 0;
            sucursalesReport.forEach(sucursal => {
                totalPizzaSucursal += cajasPorSucursal[sucursal].pizza;
                totalFingersSucursal += cajasPorSucursal[sucursal].fingers;
            });

            // Calcular Resumen de Cajas por Empresa
            const cajasPorEmpresa = {};
            // Iterar sobre cada pedido filtrado y acumular por empresa usando el mapeo Sucursal -> Empresa
            pedidosFiltrados.forEach(pedido => {
                const empresa = sucursalToEmpresaMap[pedido.Sucursal.toLowerCase()] || 'Desconocida';
                if (!cajasPorEmpresa[empresa]) {
                    cajasPorEmpresa[empresa] = { pizza: 0, fingers: 0 };
                }
                if (pedido.TipoCaja.toLowerCase() === 'pizza') {
                    cajasPorEmpresa[empresa].pizza += pedido.Cantidad;
                } else if (pedido.TipoCaja.toLowerCase() === 'fingers') {
                    cajasPorEmpresa[empresa].fingers += pedido.Cantidad;
                }
            });

            // Calcular Totales de Pizza y Fingers para todas las Empresas
            let totalPizzaEmpresa = 0;
            let totalFingersEmpresa = 0;
            Object.keys(cajasPorEmpresa).forEach(empresa => {
                totalPizzaEmpresa += cajasPorEmpresa[empresa].pizza;
                totalFingersEmpresa += cajasPorEmpresa[empresa].fingers;
            });

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += `Reporte de Pedidos de Cajas y Pagos de Cajas - ${mesSeleccionado}\n\n`;

            // Añadir el Resumen General al inicio del CSV
            csvContent += `Resumen General,,,\n`;
            csvContent += `Total Pedidos:,Q${totalPedidosGenerales.toFixed(2)},,\n`;
            csvContent += `Total Pagado:,Q${totalPagadoGenerales.toFixed(2)},,\n`;
            csvContent += `Total Pendiente:,Q${totalPendienteGenerales.toFixed(2)},,\n`;
            csvContent += `Saldo:,${saldoGenerales > 0 ? `Q${saldoGenerales.toFixed(2)}` : 'Q0.00'},,\n\n`;

            // Añadir Resumen de Cajas por Sucursal al CSV
            csvContent += `Cajas Consumidas por Sucursal,,,\n`;
            csvContent += `Sucursal,Pizza,Fingers\n`;
            if (sucursalesReport.length > 0) {
                sucursalesReport.forEach(sucursal => {
                    csvContent += `${capitalizeFirstLetter(sucursal)},${cajasPorSucursal[sucursal].pizza},${cajasPorSucursal[sucursal].fingers}\n`;
                });
                // Añadir fila de Totales
                csvContent += `Total,${totalPizzaSucursal},${totalFingersSucursal}\n`;
            } else {
                csvContent += `No hay datos de sucursales.\n`;
            }
            csvContent += `\n`;

            // Añadir Resumen de Cajas por Empresa al CSV
            csvContent += `Cajas Consumidas por Empresa,,,\n`;
            csvContent += `Empresa,Pizza,Fingers\n`;
            if (Object.keys(cajasPorEmpresa).length > 0) {
                Object.keys(cajasPorEmpresa).forEach(empresa => {
                    csvContent += `${empresa},${cajasPorEmpresa[empresa].pizza},${cajasPorEmpresa[empresa].fingers}\n`;
                });
                // Añadir fila de Totales
                csvContent += `Total,${totalPizzaEmpresa},${totalFingersEmpresa}\n`;
            } else {
                csvContent += `No hay datos de empresas.\n`;
            }
            csvContent += `\n`;

            // Añadir el Detalle de Todos los Pedidos al CSV
            csvContent += `Todos los Pedidos,,,\n`;
            csvContent += `ID,Sucursal,Tipo de Caja,Fecha,Cantidad,Precio Unitario (Q),Precio Total (Q)\n`;
            if (pedidosFiltrados.length > 0) {
                pedidosFiltrados.forEach(pedido => {
                    csvContent += `${pedido.id},${capitalizeFirstLetter(pedido.Sucursal)},${pedido.TipoCaja},${pedido.Fecha},${pedido.Cantidad},Q${pedido.PrecioUnitario.toFixed(2)},Q${pedido.PrecioTotal.toFixed(2)}\n`;
                });
                csvContent += `Total General de Pedidos:,Q${totalPedidosGenerales.toFixed(2)},,\n\n`;
            } else {
                csvContent += `No hay pedidos en el mes seleccionado.\n\n`;
            }

            // Añadir el Detalle de Todos los Pagos al CSV
            csvContent += `Todos los Pagos,,,\n`;
            csvContent += `ID,Sucursal,Fecha Pago,Número de Boleta,Total Boleta (Q)\n`;
            if (pagosFiltrados.length > 0) {
                pagosFiltrados.forEach(pago => {
                    csvContent += `${pago.id},${capitalizeFirstLetter(pago.Sucursal)},${pago.fechaPago},${pago.boletaPago},Q${pago.precioTotalPagado.toFixed(2)}\n`;
                });
                csvContent += `Total General de Pagos:,Q${totalPagadoGenerales.toFixed(2)},,\n\n`;
            } else {
                csvContent += `No hay pagos asociados al mes seleccionado.\n\n`;
            }

            // Encabezado del reporte por sucursal
            csvContent += `Reporte por Sucursal,,,\n`;
            csvContent += `Sucursal,Empresa,ID Pedido,Tipo de Caja,Fecha Pedido,Cantidad,Precio Unitario (Q),Precio Total (Q),ID Pago,Fecha Pago,Número de Boleta,Total Boleta (Q)\n`;

            sucursalesReport.forEach(sucursal => {
                const empresa = sucursalToEmpresaMap[sucursal] || 'Desconocida';

                // Filtrar pedidos y pagos para esta sucursal
                const pedidosSucursal = pedidosFiltrados.filter(p => p.Sucursal.toLowerCase() === sucursal);
                const pagosSucursal = pagosFiltrados.filter(p => p.Sucursal.toLowerCase() === sucursal);

                // Calcular Totales para esta sucursal
                const totalPedidos = pedidosSucursal.reduce((sum, pedido) => sum + pedido.PrecioTotal, 0);
                const totalPagado = pagosSucursal.reduce((sum, pago) => sum + pago.precioTotalPagado, 0);
                const totalPendiente = totalPedidos - totalPagado > 0 ? totalPedidos - totalPagado : 0;
                const saldo = totalPagado - totalPedidos > 0 ? totalPagado - totalPedidos : 0;

                // Añadir la fila de resumen por sucursal
                csvContent += `,Resumen de ${capitalizeFirstLetter(sucursal)},,,,,,,,,,,,\n`;
                csvContent += `,,,,Total Pedidos:,Q${totalPedidos.toFixed(2)},Total Pagado:,Q${totalPagado.toFixed(2)},Total Pendiente:,Q${totalPendiente.toFixed(2)},Saldo:,${saldo > 0 ? `Q${saldo.toFixed(2)}` : 'Q0.00'}\n`;

                // Añadir detalles de pedidos y pagos
                pedidosSucursal.forEach(pedido => {
                    pagosSucursal.forEach(pago => {
                        csvContent += `${pedido.id},${capitalizeFirstLetter(sucursal)},${pedido.TipoCaja},${pedido.Fecha},${pedido.Cantidad},Q${pedido.PrecioUnitario.toFixed(2)},Q${pedido.PrecioTotal.toFixed(2)},${pago.id},${pago.fechaPago},${pago.boletaPago},Q${pago.precioTotalPagado.toFixed(2)}\n`;
                    });
                });

                // Añadir una línea en blanco para separar sucursales
                csvContent += `\n`;
            });

            // Crear un enlace para descargar el CSV
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const [yearExport, monthExport] = mesSeleccionado.split('-');
            const filename = `Reporte_Pedidos_Pagos_Cajas_${yearExport}_${monthExport}.csv`;
            link.setAttribute("download", filename);
            document.body.appendChild(link); // Requerido para Firefox

            link.click(); // Este comando descarga el archivo
            document.body.removeChild(link); // Limpiar
        }

        // Función para exportar el reporte a PDF
        async function exportarPDF() {
            const mesSeleccionado = reportMesInput.value; // Formato 'YYYY-MM'
            const sucursalSeleccionada = reportSucursalSelect.value.toLowerCase();

            if (!mesSeleccionado) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Por favor, selecciona un Mes para exportar el reporte.',
                });
                return;
            }

            // Seleccionar el contenido del reporte
            const reportElement = document.getElementById('reportContent');

            if (reportElement.innerHTML.trim() === '') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No hay datos para exportar.',
                });
                return;
            }

            try {
                console.log('Iniciando generación del PDF');

                // Eliminar iframes dentro de reportContent antes de generar el PDF
                eliminarIframes(reportElement);

                // Opciones para html2pdf
                const opt = {
                    margin:       [10, 10, 10, 10], // [top, left, bottom, right]
                    filename:     `Reporte_Pedidos_Pagos_Cajas_${mesSeleccionado}.pdf`,
                    image:        { type: 'png', quality: 0.98 },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true, 
                        ignoreElements: (element) => element.classList.contains('page-break') 
                    },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }, // Orientación vertical
                    pagebreak:    { mode: ['css', 'legacy'] }
                };

                // Generar y descargar el PDF usando html2pdf.js
                await html2pdf().set(opt).from(reportElement).save();

                console.log('PDF generado y descargado exitosamente');
            } catch (error) {
                console.error('Error al generar el PDF:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Hubo un problema al generar el PDF. Por favor, inténtalo de nuevo.',
                });
            }
        }

        // Evento del botón de generar reporte
        generarReporteBtn.addEventListener('click', generarReporte);

        // Evento del botón de exportar reporte a CSV
        exportarReporteCSVBtn.addEventListener('click', exportarCSV);

        // Evento del botón de exportar reporte a PDF
        exportarReportePDFBtn.addEventListener('click', exportarPDF);
    </script>
</body>
</html>
