<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Pedidos y Pagos de Cajas</title>
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Enlace al archivo CSS -->
    <!-- Para una solución autoconclusiva, incluimos los estilos dentro de una etiqueta <style> -->
    <style>
        /* Estilos Generales */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            text-align: center;
            color: #004d40;
        }

        .select-sucursal-message {
            text-align: center;
            margin-bottom: 20px;
            color: #00695c;
            font-size: 18px;
        }

        .sucursal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sucursal-btn {
            padding: 10px 20px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .sucursal-btn:hover,
        .sucursal-btn.active {
            background-color: #004d40;
        }

        .global-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-month label {
            margin-right: 5px;
            font-weight: bold;
        }

        .close-month .add-task-btn {
            padding: 10px 20px;
            background-color: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .close-month .add-task-btn:hover {
            background-color: #b71c1c;
        }

        .split-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 300px;
        }

        .section h2 {
            color: #004d40;
            margin-bottom: 10px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .filters input,
        .filters select {
            padding: 5px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .reset-filters-btn {
            padding: 5px 10px;
            background-color: #bdbdbd;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .reset-filters-btn:hover {
            background-color: #9e9e9e;
        }

        .actions-buttons .add-task-btn {
            padding: 5px 10px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .actions-buttons .add-task-btn:hover {
            background-color: #004d40;
        }

        .summary {
            margin-bottom: 10px;
            font-size: 16px;
            color: #00695c;
        }

        .summary p {
            margin: 5px 0;
        }

        .summary strong {
            color: #004d40;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            table-layout: fixed;
            word-wrap: break-word;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }

        th {
            background-color: #f57f17;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #fff9c4;
        }

        tr:hover {
            background-color: #fff59d;
        }

        .action-btn {
            padding: 3px 6px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .edit-btn {
            background-color: #1976d2;
            color: white;
        }

        .edit-btn:hover {
            background-color: #0d47a1;
        }

        .delete-btn {
            background-color: #d32f2f;
            color: white;
        }

        .delete-btn:hover {
            background-color: #b71c1c;
        }

        /* Estilos para Modales */
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed; /* Posición fija */
            z-index: 1000; /* Por encima de otros elementos */
            left: 0;
            top: 0;
            width: 100%; /* Ancho completo */
            height: 100%; /* Alto completo */
            overflow: auto; /* Habilita scroll si es necesario */
            background-color: rgba(0, 0, 0, 0.5); /* Fondo semi-transparente */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* Centrado vertical y horizontal */
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #004d40;
        }

        .modal-content form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .modal-content form input,
        .modal-content form select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .modal-content form button {
            padding: 10px 20px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-content form button:hover {
            background-color: #004d40;
        }

        /* Responsive */
        @media (max-width: 800px) {
            .split-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor Principal de la Aplicación -->
    <div class="container" id="mainApp">
        <h1>Registro de Pedidos y Pagos de Cajas</h1>
        
        <!-- Mensaje de Selección de Sucursal -->
        <div id="selectSucursalMessage" class="select-sucursal-message">
            <p>Por favor, selecciona una sucursal para comenzar.</p>
        </div>
        
        <!-- Selección de Mes Inicial -->
        <div class="global-controls">
            <div class="filter-month">
                <label for="filterMesInicial">Selecciona el Mes Inicial:</label>
                <input type="month" id="filterMesInicial">
            </div>
        </div>
        
        <!-- Filtro Global por Sucursal -->
        <div class="sucursal-buttons">
            <button class="sucursal-btn" onclick="filtrarPorSucursal('jalapa', this)">Jalapa</button>
            <button class="sucursal-btn" onclick="filtrarPorSucursal('poptun', this)">Poptún</button>
            <button class="sucursal-btn" onclick="filtrarPorSucursal('zacapa', this)">Zacapa</button>
            <button class="sucursal-btn" onclick="filtrarPorSucursal('santa elena', this)">Santa Elena</button>
            <button class="sucursal-btn" onclick="filtrarPorSucursal('pinula', this)">Pinula</button>
            <button class="sucursal-btn" onclick="filtrarPorSucursal('eskala', this)">Eskala</button>
        </div>

        <!-- Controles Globales -->
        <div class="global-controls">
            <!-- Botón de Cierre de Mes -->
            <div class="close-month">
                <button class="add-task-btn" onclick="realizarCierreMes()">Realizar Cierre de Mes</button>
            </div>
        </div>

        <!-- Contenedor de Pedidos y Pagos -->
        <div class="split-container" id="appContent" style="display: none;">
            <!-- Sección de Pedidos -->
            <div class="section pedidos-section">
                <h2>Pedidos</h2>
                
                <!-- Filtros y Controles de Pedidos -->
                <div class="table-controls">
                    <div class="filters">
                        <input type="text" id="searchInputPedidos" placeholder="Buscar pedidos..." oninput="mostrarPedidos(selectedSucursal)">

                        <select id="filterTipoCajaPedidos" onchange="mostrarPedidos(selectedSucursal)">
                            <option value="">Todos los Tipos</option>
                            <option value="Pizza">Pizza</option>
                            <option value="Fingers">Fingers</option>
                        </select>

                        <input type="date" id="filterFechaDesdePedidos" onchange="mostrarPedidos(selectedSucursal)" placeholder="Fecha Desde">
                        <input type="date" id="filterFechaHastaPedidos" onchange="mostrarPedidos(selectedSucursal)" placeholder="Fecha Hasta">

                        <select id="sortOrderPedidos" onchange="mostrarPedidos(selectedSucursal)">
                            <option value="idAsc" selected>ID Ascendente</option>
                            <option value="idDesc">ID Descendente</option>
                            <option value="fechaAsc">Fecha Ascendente</option>
                            <option value="fechaDesc">Fecha Descendente</option>
                        </select>

                        <button id="resetFiltersPedidos" class="reset-filters-btn">Resetear Filtros</button>
                    </div>
                    <div class="actions-buttons">
                        <button class="add-task-btn" onclick="abrirModalPedido()">Agregar Pedido</button>
                    </div>
                </div>

                <!-- Resumen de Pedidos -->
                <div id="summaryPedidos" class="summary">
                    <p>Cantidad de Cajas de Pizza: <strong id="totalPizzaPedidos">0</strong></p>
                    <p>Cantidad de Cajas de Fingers: <strong id="totalFingersPedidos">0</strong></p>
                    <p>Precio Total de Cajas: <strong id="totalPrecioPedidos">Q0.00</strong></p>
                </div>

                <!-- Tabla de Pedidos -->
                <div class="table-container">
                    <table id="pedidoTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Empresa</th>
                                <th>Sucursal</th>
                                <th>Tipo de Caja</th>
                                <th>Fecha</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario (Q)</th>
                                <th>Precio Total (Q)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los pedidos se generarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sección de Pagos -->
            <div class="section pagos-section">
                <h2>Pagos</h2>

                <!-- Controles de Filtrado, Búsqueda y Ordenamiento -->
                <div class="table-controls">
                    <div class="filters">
                        <input type="text" id="searchInputPagos" placeholder="Buscar pagos..." oninput="mostrarPagos()">

                        <input type="month" id="filterMesPago" onchange="mostrarPagos()" placeholder="Mes Pago">

                        <input type="date" id="filterFechaDesdePagos" onchange="mostrarPagos()" placeholder="Fecha Desde">
                        <input type="date" id="filterFechaHastaPagos" onchange="mostrarPagos()" placeholder="Fecha Hasta">

                        <select id="sortOrderPagos" onchange="mostrarPagos()">
                            <option value="idAsc" selected>ID Ascendente</option>
                            <option value="idDesc">ID Descendente</option>
                            <option value="fechaAsc">Fecha Ascendente</option>
                            <option value="fechaDesc">Fecha Descendente</option>
                        </select>

                        <button id="resetFiltersPagos" class="reset-filters-btn">Resetear Filtros</button>
                    </div>
                    <div class="actions-buttons">
                        <button class="add-task-btn" onclick="abrirModalPago()">Registrar Pago</button>
                    </div>
                </div>

                <!-- Resumen de Pagos -->
                <div id="summaryPagos" class="summary">
                    <p>Total Pagado: <strong id="totalPagado">Q0.00</strong></p>
                    <p>Total Pendiente: <strong id="totalPendiente">Q0.00</strong></p>
                    <p>Saldo: <strong id="saldo">Q0.00</strong></p>
                </div>

                <!-- Tabla de Pagos -->
                <div class="table-container">
                    <table id="pagoTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Mes Pago</th>
                                <th>Fecha Pago</th>
                                <th>Número de Boleta</th>
                                <th>Total Boleta (Q)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los pagos se generarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modales -->

        <!-- Modal para Agregar/Editar Pedido -->
        <div id="pedidoModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModalPedido()">&times;</span>
                <h2 id="modalTitlePedido">Agregar Pedido</h2>
                <form id="pedidoForm">
                    <label for="tipoCajaPedido">Tipo de Caja:</label>
                    <select id="tipoCajaPedido" required>
                        <option value="">Selecciona un tipo</option>
                        <option value="Pizza">Pizza</option>
                        <option value="Fingers">Fingers</option>
                    </select>

                    <label for="fechaPedido">Fecha:</label>
                    <input type="date" id="fechaPedido" required>

                    <label for="cantidadPedido">Cantidad:</label>
                    <input type="number" id="cantidadPedido" min="1" required>

                    <label for="precioUnitarioPedido">Precio Unitario (Q):</label>
                    <input type="number" id="precioUnitarioPedido" min="0" step="0.01" required>

                    <label for="precioTotalPedido">Precio Total (Q):</label>
                    <input type="number" id="precioTotalPedido" min="0" step="0.01" readonly>

                    <button type="submit">Guardar Pedido</button>
                </form>
            </div>
        </div>

        <!-- Modal para Registrar Pago -->
        <div id="pagoModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModalPago()">&times;</span>
                <h2 id="modalTitlePago">Registrar Pago</h2>
                <form id="pagoForm">
                    <label for="fechaPago">Fecha Pago:</label>
                    <input type="date" id="fechaPago" required>

                    <label for="boletaPago">Número de Boleta:</label>
                    <input type="text" id="boletaPago" required>

                    <label for="precioTotalPagado">Total Boleta (Q):</label>
                    <input type="number" id="precioTotalPagado" min="0" step="0.01" required>

                    <!-- Eliminado el campo de selección de Pedido -->

                    <button type="submit">Registrar Pago</button>
                </form>
            </div>
        </div>

        <!-- SweetAlert2 JS -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <!-- Script para Manejar el Registro de Pedidos y Pagos -->
        <script>
            // Datos iniciales de Sucursales
            const data = [
                { Empresa: "VIPIZZA", Sucursal: "jalapa", PizzaMensual: 3462, FingersMensual: 356 },
                { Empresa: "VIPIZZA", Sucursal: "poptun", PizzaMensual: 3992, FingersMensual: 312 },
                { Empresa: "VIPIZZA", Sucursal: "zacapa", PizzaMensual: 5706, FingersMensual: 611 },
                { Empresa: "AMERICAN PIZZA", Sucursal: "santa elena", PizzaMensual: 5893, FingersMensual: 287 },
                { Empresa: "AMERICAN PIZZA", Sucursal: "pinula", PizzaMensual: 4639, FingersMensual: 379 },
                { Empresa: "AMERICAN PIZZA", Sucursal: "eskala", PizzaMensual: 2460, FingersMensual: 211 },
            ];

            // Inicialización de datos
            let pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
            let pagos = JSON.parse(localStorage.getItem('pagos')) || [];
            let lastIdPedidos = parseInt(localStorage.getItem('lastIdPedidos')) || 0;
            let lastIdPagos = parseInt(localStorage.getItem('lastIdPagos')) || 0;
            let selectedSucursal = ''; // Inicialmente ninguna sucursal seleccionada
            let selectedMes = ''; // Mes seleccionado para filtrar

            // Inicializar con datos predefinidos si no hay pedidos
            if (pedidos.length === 0) {
                const datosIniciales = [
                    { id: 1, Empresa: "VIPIZZA", Sucursal: "jalapa", TipoCaja: "Pizza", Fecha: "2024-01-10", Cantidad: 50, PrecioUnitario: 10.00, PrecioTotal: 500.00, CantidadPagada: 0 },
                    { id: 2, Empresa: "VIPIZZA", Sucursal: "poptun", TipoCaja: "Fingers", Fecha: "2024-01-15", Cantidad: 30, PrecioUnitario: 5.00, PrecioTotal: 150.00, CantidadPagada: 0 },
                    { id: 3, Empresa: "AMERICAN PIZZA", Sucursal: "santa elena", TipoCaja: "Pizza", Fecha: "2024-02-05", Cantidad: 60, PrecioUnitario: 12.00, PrecioTotal: 720.00, CantidadPagada: 0 },
                    { id: 4, Empresa: "AMERICAN PIZZA", Sucursal: "pinula", TipoCaja: "Fingers", Fecha: "2024-02-20", Cantidad: 40, PrecioUnitario: 6.00, PrecioTotal: 240.00, CantidadPagada: 0 },
                ];
                pedidos = datosIniciales;
                lastIdPedidos = 4;
                localStorage.setItem('pedidos', JSON.stringify(pedidos));
                localStorage.setItem('lastIdPedidos', lastIdPedidos);
            }

            // Elementos del DOM
            // Mensaje de Selección de Sucursal
            const selectSucursalMessage = document.getElementById('selectSucursalMessage');

            // Contenido de la Aplicación
            const appContent = document.getElementById('appContent');

            // Modales
            const pedidoModal = document.getElementById('pedidoModal');
            const modalTitlePedido = document.getElementById('modalTitlePedido');
            const pedidoForm = document.getElementById('pedidoForm');

            const pagoModal = document.getElementById('pagoModal');
            const modalTitlePago = document.getElementById('modalTitlePago');
            const pagoForm = document.getElementById('pagoForm');

            // Pedidos
            const tipoCajaSelectPedido = document.getElementById('tipoCajaPedido');
            const fechaPedidoInput = document.getElementById('fechaPedido');
            const cantidadInputPedido = document.getElementById('cantidadPedido');
            const precioUnitarioInputPedido = document.getElementById('precioUnitarioPedido');
            const precioTotalInputPedido = document.getElementById('precioTotalPedido');

            // Pagos
            const fechaPagoInput = document.getElementById('fechaPago');
            const boletaPagoInput = document.getElementById('boletaPago');
            const precioTotalPagadoInputPago = document.getElementById('precioTotalPagado');
            // Eliminado el campo de selección de Pedido
            // const pedidoSeleccionado = document.getElementById('pedidoSeleccionado');

            // Filtros y Búsqueda Pedidos
            const searchInputPedidos = document.getElementById('searchInputPedidos');
            const filterTipoCajaPedidos = document.getElementById('filterTipoCajaPedidos');
            const filterFechaDesdePedidos = document.getElementById('filterFechaDesdePedidos');
            const filterFechaHastaPedidos = document.getElementById('filterFechaHastaPedidos');
            const sortOrderPedidos = document.getElementById('sortOrderPedidos');
            const resetFiltersPedidos = document.getElementById('resetFiltersPedidos');

            // Filtros y Búsqueda Pagos
            const searchInputPagos = document.getElementById('searchInputPagos');
            const filterFechaDesdePagos = document.getElementById('filterFechaDesdePagos');
            const filterFechaHastaPagos = document.getElementById('filterFechaHastaPagos');
            const sortOrderPagos = document.getElementById('sortOrderPagos');
            const resetFiltersPagos = document.getElementById('resetFiltersPagos');

            // Resumen
            const totalPizzaPedidosEl = document.getElementById('totalPizzaPedidos');
            const totalFingersPedidosEl = document.getElementById('totalFingersPedidos');
            const totalPrecioPedidosEl = document.getElementById('totalPrecioPedidos');

            const totalPagadoEl = document.getElementById('totalPagado');
            const totalPendienteEl = document.getElementById('totalPendiente');
            const saldoEl = document.getElementById('saldo'); // Nuevo elemento para Saldo

            // Funciones para el Modal de Pedido
            function abrirModalPedido() {
                if (!selectedSucursal || selectedSucursal === '') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, selecciona una Sucursal antes de agregar un Pedido.',
                    });
                    return;
                }
                pedidoForm.reset();
                precioTotalInputPedido.value = '';
                modalTitlePedido.textContent = "Agregar Pedido";
                pedidoModal.style.display = "block";
            }

            function cerrarModalPedido() {
                pedidoModal.style.display = "none";
            }

            // Funciones para el Modal de Pago
            function abrirModalPago() {
                if (!selectedSucursal || selectedSucursal === '') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, selecciona una Sucursal antes de registrar un Pago.',
                    });
                    return;
                }
                pagoForm.reset();
                precioTotalPagadoInputPago.value = '';

                // Asignar el mes seleccionado al pago
                let mesPago = selectedMes; // Formato 'YYYY-MM'
                if (!mesPago) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, selecciona un Mes Inicial antes de registrar un Pago.',
                    });
                    return;
                }

                modalTitlePago.textContent = "Registrar Pago";
                // No es necesario actualizar el select de pedidos ya que no se asocia a un pedido específico
                pagoModal.style.display = "block";
            }

            function cerrarModalPago() {
                pagoModal.style.display = "none";
            }

            // Cerrar los modales al hacer clic fuera
            window.onclick = function(event) {
                if (event.target == pedidoModal) {
                    cerrarModalPedido();
                }
                if (event.target == pagoModal) {
                    cerrarModalPago();
                }
            }

            // Calcular Precio Total automáticamente en Pedido
            function actualizarPrecioTotalPedido() {
                const cantidad = parseInt(cantidadInputPedido.value) || 0;
                const precioUnitario = parseFloat(precioUnitarioInputPedido.value) || 0;
                const precioTotal = cantidad * precioUnitario;
                precioTotalInputPedido.value = precioTotal.toFixed(2);
            }

            cantidadInputPedido.addEventListener('input', actualizarPrecioTotalPedido);
            precioUnitarioInputPedido.addEventListener('input', actualizarPrecioTotalPedido);

            // Manejar el envío del formulario para agregar/editar Pedido
            pedidoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const tipoCaja = tipoCajaSelectPedido.value;
                const fecha = fechaPedidoInput.value;
                const cantidad = parseInt(cantidadInputPedido.value) || 0;
                const precioUnitario = parseFloat(precioUnitarioInputPedido.value) || 0;
                const precioTotal = parseFloat(precioTotalInputPedido.value) || 0;

                if (!tipoCaja || !fecha || cantidad <= 0 || precioUnitario <= 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, completa todos los campos correctamente.',
                    });
                    return;
                }

                // Determinar si se está editando o agregando un pedido
                const isEditing = modalTitlePedido.textContent === "Editar Pedido";
                if (isEditing) {
                    const pedidoId = parseInt(pedidoForm.dataset.pedidoId);
                    const pedidoIndex = pedidos.findIndex(p => p.id === pedidoId);
                    if (pedidoIndex !== -1) {
                        pedidos[pedidoIndex].TipoCaja = tipoCaja;
                        pedidos[pedidoIndex].Fecha = fecha;
                        pedidos[pedidoIndex].Cantidad = cantidad;
                        pedidos[pedidoIndex].PrecioUnitario = precioUnitario;
                        pedidos[pedidoIndex].PrecioTotal = precioTotal;
                        // No se actualiza CantidadPagada aquí
                        Swal.fire({
                            icon: 'success',
                            title: 'Actualizado',
                            text: 'Pedido actualizado correctamente.',
                        });
                    }
                } else {
                    // Agregar un nuevo pedido con ID incremental
                    lastIdPedidos += 1;
                    const nuevoPedido = {
                        id: lastIdPedidos,
                        Empresa: obtenerEmpresaPorSucursal(selectedSucursal),
                        Sucursal: selectedSucursal,
                        TipoCaja: tipoCaja,
                        Fecha: fecha,
                        Cantidad: cantidad,
                        PrecioUnitario: precioUnitario,
                        PrecioTotal: precioTotal,
                        CantidadPagada: 0
                    };
                    pedidos.push(nuevoPedido);
                    Swal.fire({
                        icon: 'success',
                        title: 'Agregado',
                        text: 'Pedido agregado correctamente.',
                    });
                }

                // Guardar en localStorage
                localStorage.setItem('pedidos', JSON.stringify(pedidos));
                localStorage.setItem('lastIdPedidos', lastIdPedidos);

                // Actualizar la tabla y el resumen
                mostrarPedidos(selectedSucursal);
                mostrarPagos(); // Actualizar pagos para reflejar cambios en saldo

                // Cerrar el modal
                cerrarModalPedido();
            });

            // Manejar el envío del formulario para agregar/editar Pago
            pagoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const fechaPago = fechaPagoInput.value;
                const boletaPago = boletaPagoInput.value.trim();
                const precioTotalPagado = parseFloat(precioTotalPagadoInputPago.value) || 0;
                const mesPago = filterMesInicial.value; // Formato 'YYYY-MM'

                if (!fechaPago || !boletaPago || precioTotalPagado <= 0 || !mesPago) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, completa todos los campos correctamente y asegúrate de que el Mes Inicial esté seleccionado.',
                    });
                    return;
                }

                // Calcular el total de pedidos en el mes seleccionado
                const [year, month] = mesPago.split('-').map(num => parseInt(num));
                const pedidosMes = pedidos.filter(pedido => {
                    const pedidoDate = new Date(pedido.Fecha);
                    return pedidoDate.getFullYear() === year && (pedidoDate.getMonth() + 1) === month;
                });

                const totalPedidosMes = parseFloat(
                    pedidosMes.reduce((sum, pedido) => sum + pedido.PrecioTotal, 0).toFixed(2)
                );
                const totalPagadoMes = parseFloat(
                    pagos
                        .filter(pago => pago.mes === mesPago)
                        .reduce((sum, pago) => sum + pago.precioTotalPagado, 0)
                        .toFixed(2)
                );

                let pendienteMes = parseFloat((totalPedidosMes - totalPagadoMes).toFixed(2));
                pendienteMes = pendienteMes > 0 ? pendienteMes : 0;

                // Definir un pequeño margen de error para la comparación
                const epsilon = 0.01; // Puedes ajustar este valor según tus necesidades

                if (precioTotalPagado > (pendienteMes + epsilon)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: `El monto pagado excede el pendiente del Mes Seleccionado (Q${pendienteMes.toFixed(2)}).`,
                    });
                    return;
                }

                // Determinar si se está editando o agregando un pago
                const isEditing = modalTitlePago.textContent === "Editar Pago";
                if (isEditing) {
                    const pagoId = parseInt(pagoForm.dataset.pagoId);
                    const pagoIndex = pagos.findIndex(p => p.id === pagoId);
                    if (pagoIndex !== -1) {
                        // Restaurar el monto anterior al total pagado del mes
                        const montoAnterior = pagos[pagoIndex].precioTotalPagado;
                        pagos[pagoIndex].precioTotalPagado = precioTotalPagado;
                        pagos[pagoIndex].fechaPago = fechaPago;
                        pagos[pagoIndex].boletaPago = boletaPago;
                        pagos[pagoIndex].mes = mesPago;

                        Swal.fire({
                            icon: 'success',
                            title: 'Actualizado',
                            text: 'Pago actualizado correctamente.',
                        });
                    }
                } else {
                    // Agregar un nuevo pago con ID incremental
                    lastIdPagos += 1;
                    const nuevoPago = {
                        id: lastIdPagos,
                        Sucursal: selectedSucursal,
                        fechaPago: fechaPago,
                        boletaPago: boletaPago,
                        precioTotalPagado: precioTotalPagado,
                        mes: mesPago // Asocia el pago al mes seleccionado
                    };
                    pagos.push(nuevoPago);
                    Swal.fire({
                        icon: 'success',
                        title: 'Registrado',
                        text: 'Pago registrado correctamente.',
                    });
                }

                // Guardar en localStorage
                localStorage.setItem('pagos', JSON.stringify(pagos));
                localStorage.setItem('lastIdPagos', lastIdPagos);

                // Actualizar las tablas y resúmenes
                mostrarPagos();
                mostrarPedidos(selectedSucursal);

                // Cerrar el modal
                cerrarModalPago();
            });

            // Obtener la Empresa basada en la Sucursal seleccionada
            function obtenerEmpresaPorSucursal(sucursal) {
                const sucursalData = data.find(item => item.Sucursal.toLowerCase() === sucursal.toLowerCase());
                return sucursalData ? sucursalData.Empresa : 'Desconocida';
            }

            // Mostrar los pedidos en la tabla y actualizar el resumen
            function mostrarPedidos(sucursalFiltrada) {
                let pedidosFiltrados = [...pedidos];

                // Filtrar por Sucursal
                if (sucursalFiltrada !== '') {
                    pedidosFiltrados = pedidosFiltrados.filter(pedido => pedido.Sucursal.toLowerCase() === sucursalFiltrada.toLowerCase());
                }

                // Filtrar por Mes
                if (selectedMes !== '') {
                    const [year, month] = selectedMes.split('-');
                    pedidosFiltrados = pedidosFiltrados.filter(pedido => {
                        const pedidoDate = new Date(pedido.Fecha);
                        return pedidoDate.getFullYear() === parseInt(year) && (pedidoDate.getMonth() + 1) === parseInt(month);
                    });
                }

                const tipoCajaFilter = filterTipoCajaPedidos.value;
                const fechaDesdeFilter = filterFechaDesdePedidos.value;
                const fechaHastaFilter = filterFechaHastaPedidos.value;
                const searchTerm = searchInputPedidos.value.toLowerCase();
                const sort = sortOrderPedidos.value;

                // Filtrar por Tipo de Caja
                if (tipoCajaFilter) {
                    pedidosFiltrados = pedidosFiltrados.filter(pedido => pedido.TipoCaja === tipoCajaFilter);
                }

                // Filtrar por Fecha Desde
                if (fechaDesdeFilter) {
                    pedidosFiltrados = pedidosFiltrados.filter(pedido => pedido.Fecha >= fechaDesdeFilter);
                }

                // Filtrar por Fecha Hasta
                if (fechaHastaFilter) {
                    pedidosFiltrados = pedidosFiltrados.filter(pedido => pedido.Fecha <= fechaHastaFilter);
                }

                // Buscar por ID, Empresa, Sucursal, Tipo de Caja
                if (searchTerm) {
                    pedidosFiltrados = pedidosFiltrados.filter(pedido =>
                        pedido.id.toString().includes(searchTerm) ||
                        pedido.Empresa.toLowerCase().includes(searchTerm) ||
                        pedido.Sucursal.toLowerCase().includes(searchTerm) ||
                        pedido.TipoCaja.toLowerCase().includes(searchTerm)
                    );
                }

                // Ordenar
                pedidosFiltrados.sort((a, b) => {
                    if (sort === 'idAsc') {
                        return a.id - b.id;
                    } else if (sort === 'idDesc') {
                        return b.id - a.id;
                    } else if (sort === 'fechaAsc') {
                        return new Date(a.Fecha) - new Date(b.Fecha);
                    } else if (sort === 'fechaDesc') {
                        return new Date(b.Fecha) - new Date(a.Fecha);
                    }
                    return 0;
                });

                // Limpiar la tabla
                const pedidoTableBody = document.querySelector('#pedidoTable tbody');
                pedidoTableBody.innerHTML = '';

                // Variables para el resumen
                let totalPizza = 0;
                let totalFingers = 0;
                let totalPrecio = 0;

                // Llenar la tabla con los pedidos filtrados y calcular el resumen
                pedidosFiltrados.forEach(pedido => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${pedido.id}</td>
                        <td>${pedido.Empresa}</td>
                        <td>${capitalizeFirstLetter(pedido.Sucursal)}</td>
                        <td>${pedido.TipoCaja}</td>
                        <td>${pedido.Fecha}</td>
                        <td>${pedido.Cantidad}</td>
                        <td>Q${pedido.PrecioUnitario.toFixed(2)}</td>
                        <td>Q${pedido.PrecioTotal.toFixed(2)}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editarPedido(${pedido.id})">Editar</button>
                            <button class="action-btn delete-btn" onclick="eliminarPedido(${pedido.id})">Eliminar</button>
                        </td>
                    `;
                    pedidoTableBody.appendChild(tr);

                    // Calcular totales
                    if (pedido.TipoCaja.toLowerCase() === 'pizza') {
                        totalPizza += pedido.Cantidad;
                    } else if (pedido.TipoCaja.toLowerCase() === 'fingers') {
                        totalFingers += pedido.Cantidad;
                    }
                    totalPrecio += pedido.PrecioTotal;
                });

                // Actualizar el resumen en el DOM
                totalPizzaPedidosEl.textContent = totalPizza;
                totalFingersPedidosEl.textContent = totalFingers;
                totalPrecioPedidosEl.textContent = `Q${totalPrecio.toFixed(2)}`;

                // No es necesario actualizar el select de pedidos en el modal de pago
            }

            // Mostrar los pagos en la tabla y actualizar el resumen
            function mostrarPagos() {
                let pagosFiltrados = [...pagos];

                // Filtrar por Sucursal de manera global
                if (selectedSucursal !== '') {
                    pagosFiltrados = pagosFiltrados.filter(pago => pago.Sucursal.toLowerCase() === selectedSucursal.toLowerCase());
                }

                // Filtrar por Mes Pago
                const filtroMesPago = document.getElementById('filterMesPago').value; // Formato 'YYYY-MM'
                if (filtroMesPago) {
                    pagosFiltrados = pagosFiltrados.filter(pago => pago.mes === filtroMesPago);
                } else if (selectedMes) {
                    // Si no hay filtro específico de pago, filtrar por el mes inicial seleccionado
                    pagosFiltrados = pagosFiltrados.filter(pago => pago.mes === selectedMes);
                }

                const fechaDesdeFilter = filterFechaDesdePagos.value;
                const fechaHastaFilter = filterFechaHastaPagos.value;
                const searchTerm = searchInputPagos.value.toLowerCase();
                const sort = sortOrderPagos.value;

                // Filtrar por Fecha Desde
                if (fechaDesdeFilter) {
                    pagosFiltrados = pagosFiltrados.filter(pago => pago.fechaPago >= fechaDesdeFilter);
                }

                // Filtrar por Fecha Hasta
                if (fechaHastaFilter) {
                    pagosFiltrados = pagosFiltrados.filter(pago => pago.fechaPago <= fechaHastaFilter);
                }

                // Buscar por ID o Número de Boleta
                if (searchTerm) {
                    pagosFiltrados = pagosFiltrados.filter(pago =>
                        pago.id.toString().includes(searchTerm) ||
                        pago.boletaPago.toLowerCase().includes(searchTerm)
                    );
                }

                // Ordenar
                pagosFiltrados.sort((a, b) => {
                    if (sort === 'idAsc') {
                        return a.id - b.id;
                    } else if (sort === 'idDesc') {
                        return b.id - a.id;
                    } else if (sort === 'fechaAsc') {
                        return new Date(a.fechaPago) - new Date(b.fechaPago);
                    } else if (sort === 'fechaDesc') {
                        return new Date(b.fechaPago) - new Date(a.fechaPago);
                    }
                    return 0;
                });

                // Limpiar la tabla
                const pagoTableBody = document.querySelector('#pagoTable tbody');
                pagoTableBody.innerHTML = '';

                // Variables para el resumen
                let totalPagado = 0;

                // Calcular total pagado
                pagosFiltrados.forEach(pago => {
                    totalPagado += pago.precioTotalPagado;
                });

                // Calcular Precio Total de Cajas del mes seleccionado
                let totalPrecioCajas = 0;
                if (selectedMes !== '') {
                    const [year, month] = selectedMes.split('-').map(num => parseInt(num));
                    totalPrecioCajas = pedidos
                        .filter(pedido => 
                            pedido.Sucursal.toLowerCase() === selectedSucursal.toLowerCase() &&
                            new Date(pedido.Fecha).getFullYear() === year &&
                            (new Date(pedido.Fecha).getMonth() + 1) === month
                        )
                        .reduce((sum, pedido) => sum + pedido.PrecioTotal, 0);
                }

                // Calcular saldo
                const saldo = totalPagado - totalPrecioCajas;

                // Llenar la tabla con los pagos filtrados
                pagosFiltrados.forEach(pago => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${pago.id}</td>
                        <td>${pago.mes}</td>
                        <td>${pago.fechaPago}</td>
                        <td>${pago.boletaPago}</td>
                        <td>Q${pago.precioTotalPagado.toFixed(2)}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editarPago(${pago.id})">Editar</button>
                            <button class="action-btn delete-btn" onclick="eliminarPago(${pago.id})">Eliminar</button>
                        </td>
                    `;
                    pagoTableBody.appendChild(tr);
                });

                // Calcular Total Pendiente
                const totalPendiente = totalPrecioCajas - totalPagado > 0 ? totalPrecioCajas - totalPagado : 0;

                // Actualizar el resumen en el DOM
                totalPagadoEl.textContent = `Q${totalPagado.toFixed(2)}`;
                totalPendienteEl.textContent = `Q${totalPendiente.toFixed(2)}`;
                saldoEl.textContent = saldo > 0 ? `Q${saldo.toFixed(2)}` : `Q0.00`;

                // Aplicar estilos al saldo
                if (saldo > 0) {
                    saldoEl.style.color = 'green';
                } else {
                    saldoEl.style.color = 'red';
                }

                // Aplicar estilos al total pendiente
                if (totalPendiente > 0) {
                    totalPendienteEl.style.color = 'red';
                } else {
                    totalPendienteEl.style.color = 'green';
                }
            }

            // Función para filtrar por Sucursal de manera global
            function filtrarPorSucursal(sucursal, buttonSeleccionado) {
                selectedSucursal = sucursal.toLowerCase();
                actualizarBotonesSucursal(buttonSeleccionado);
                // Ocultar el mensaje y mostrar el contenido de la aplicación
                selectSucursalMessage.style.display = "none";
                appContent.style.display = "flex";
                mostrarPedidos(selectedSucursal);
                mostrarPagos();
            }

            // Función para actualizar la apariencia de los botones de sucursal
            function actualizarBotonesSucursal(buttonSeleccionado) {
                const botones = document.querySelectorAll('.sucursal-btn');
                botones.forEach(btn => {
                    btn.classList.remove('active');
                });
                buttonSeleccionado.classList.add('active');
            }

            // Resetear los filtros de Pedidos
            resetFiltersPedidos.addEventListener('click', function() {
                searchInputPedidos.value = '';
                filterTipoCajaPedidos.value = '';
                filterFechaDesdePedidos.value = '';
                filterFechaHastaPedidos.value = '';
                sortOrderPedidos.value = 'idAsc';
                mostrarPedidos(selectedSucursal);
            });

            // Resetear los filtros de Pagos
            resetFiltersPagos.addEventListener('click', function() {
                searchInputPagos.value = '';
                filterFechaDesdePagos.value = '';
                filterFechaHastaPagos.value = '';
                sortOrderPagos.value = 'idAsc';
                mostrarPagos();
            });

            // Función para editar un Pedido
            function editarPedido(id) {
                const pedido = pedidos.find(p => p.id === id);
                if (pedido) {
                    modalTitlePedido.textContent = "Editar Pedido";
                    tipoCajaSelectPedido.value = pedido.TipoCaja;
                    fechaPedidoInput.value = pedido.Fecha;
                    cantidadInputPedido.value = pedido.Cantidad;
                    precioUnitarioInputPedido.value = pedido.PrecioUnitario;
                    precioTotalInputPedido.value = pedido.PrecioTotal.toFixed(2);
                    pedidoForm.dataset.pedidoId = pedido.id;
                    pedidoModal.style.display = "block";
                }
            }

            // Función para eliminar un Pedido
            function eliminarPedido(id) {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "Esto eliminará el Pedido y todos sus Pagos asociados. ¡No podrás revertir esto!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Obtener el pedido a eliminar
                        const pedido = pedidos.find(p => p.id === id);
                        const sucursalPedido = pedido ? pedido.Sucursal.toLowerCase() : '';

                        // Eliminar los pagos asociados a este mes del pedido
                        pagos = pagos.filter(pago => pago.mes !== getMesDePedido(pedido));

                        // Eliminar el pedido
                        pedidos = pedidos.filter(p => p.id !== id);

                        // Actualizar localStorage
                        localStorage.setItem('pedidos', JSON.stringify(pedidos));
                        localStorage.setItem('pagos', JSON.stringify(pagos));
                        localStorage.setItem('lastIdPedidos', lastIdPedidos);
                        localStorage.setItem('lastIdPagos', lastIdPagos);

                        // Actualizar las tablas y resúmenes
                        mostrarPedidos(selectedSucursal);
                        mostrarPagos();
                        Swal.fire(
                            'Eliminado!',
                            'Tu pedido y sus pagos asociados han sido eliminados.',
                            'success'
                        )
                    }
                })
            }

            // Función para obtener el mes de un pedido
            function getMesDePedido(pedido) {
                if (!pedido || !pedido.Fecha) return '';
                const [year, month] = pedido.Fecha.split('-');
                return `${year}-${month}`;
            }

            // Función para editar un Pago
            function editarPago(id) {
                const pago = pagos.find(p => p.id === id);
                if (pago) {
                    modalTitlePago.textContent = "Editar Pago";
                    fechaPagoInput.value = pago.fechaPago;
                    boletaPagoInput.value = pago.boletaPago;
                    precioTotalPagadoInputPago.value = pago.precioTotalPagado.toFixed(2);
                    // No hay campo para seleccionar pedido
                    pagoForm.dataset.pagoId = pago.id;
                    pagoModal.style.display = "block";
                }
            }

            // Función para eliminar un Pago
            function eliminarPago(id) {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "No podrás revertir esto!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Obtener el pago a eliminar
                        const pago = pagos.find(p => p.id === id);
                        const mesPago = pago ? pago.mes : '';

                        // Eliminar el pago
                        pagos = pagos.filter(p => p.id !== id);
                        localStorage.setItem('pagos', JSON.stringify(pagos));

                        // Actualizar las tablas y resúmenes
                        mostrarPagos();
                        mostrarPedidos(selectedSucursal);
                        Swal.fire(
                            'Eliminado!',
                            'Tu pago ha sido eliminado.',
                            'success'
                        )
                    }
                })
            }

            // Función para filtrar por Mes Inicial
            const filterMesInicial = document.getElementById('filterMesInicial');
            filterMesInicial.addEventListener('change', function() {
                const mesSeleccionado = filterMesInicial.value;
                if (mesSeleccionado) {
                    selectedMes = mesSeleccionado;
                    if (selectedSucursal !== '') {
                        mostrarPedidos(selectedSucursal);
                        mostrarPagos();
                    }
                }
            });

            // Función para realizar el cierre de mes
            function realizarCierreMes() {
                if (!selectedSucursal || selectedSucursal === '') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, selecciona una Sucursal antes de realizar el Cierre de Mes.',
                    });
                    return;
                }
                // Redirigir a la página de cierre de mes con parámetros
                const filterMesInput = document.getElementById('filterMesInicial');
                const mesSeleccionado = filterMesInput.value;
                if (!mesSeleccionado) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, selecciona un Mes para realizar el Cierre de Mes.',
                    });
                    return;
                }
                window.open(`cierre_mes.html?sucursal=${selectedSucursal}&mes=${mesSeleccionado}`, '_blank');
            }

            // Inicializar las tablas al cargar la página
            window.onload = function() {
                mostrarPedidos(selectedSucursal);
                mostrarPagos();
            }

            // Función para capitalizar la primera letra
            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
        </script>
    </div>
</body>
</html>
