<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Facturas y Pagos</title>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #004d40;
        }
        .select-sucursal-message {
            text-align: center;
            margin-bottom: 20px;
            color: #00695c;
            font-size: 18px;
        }
        .sucursal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .sucursal-btn {
            padding: 10px 20px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .sucursal-btn:hover,
        .sucursal-btn.active {
            background-color: #004d40;
        }
        .global-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-month label {
            margin-right: 5px;
            font-weight: bold;
        }
        .close-month .add-task-btn {
            padding: 10px 20px;
            background-color: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .close-month .add-task-btn:hover {
            background-color: #b71c1c;
        }
        .split-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 300px;
        }
        .section h2 {
            color: #004d40;
            margin-bottom: 10px;
        }
        .table-controls {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .filters input,
        .filters select {
            padding: 5px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .reset-filters-btn {
            padding: 5px 10px;
            background-color: #bdbdbd;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .reset-filters-btn:hover {
            background-color: #9e9e9e;
        }
        .actions-buttons .add-task-btn {
            padding: 5px 10px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .actions-buttons .add-task-btn:hover {
            background-color: #004d40;
        }
        .summary {
            margin-bottom: 10px;
            font-size: 16px;
            color: #00695c;
        }
        .summary p {
            margin: 5px 0;
        }
        .summary strong {
            color: #004d40;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            table-layout: fixed;
            word-wrap: break-word;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        th {
            background-color: #f57f17;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #fff9c4;
        }
        tr:hover {
            background-color: #fff59d;
        }
        .action-btn {
            padding: 3px 6px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        .edit-btn {
            background-color: #1976d2;
            color: white;
        }
        .edit-btn:hover {
            background-color: #0d47a1;
        }
        .delete-btn {
            background-color: #d32f2f;
            color: white;
        }
        .delete-btn:hover {
            background-color: #b71c1c;
        }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
        }
        .modal-content h2 {
            margin-bottom: 20px;
            color: #004d40;
        }
        .modal-content form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .modal-content form input,
        .modal-content form textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .modal-content form textarea {
            resize: vertical;
        }
        .modal-content form button {
            padding: 10px 20px;
            background-color: #00796b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .modal-content form button:hover {
            background-color: #004d40;
        }
        @media (max-width: 800px) {
            .split-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainApp">
        <h1>Registro de Facturas y Pagos</h1>
        
        <div id="selectSucursalMessage" class="select-sucursal-message">
            <p>Por favor, selecciona una Sucursal para comenzar.</p>
        </div>
        
        <!-- Selección de Mes -->
        <div class="global-controls">
            <div class="filter-month">
                <label for="filterMesInicial">Selecciona el Mes Inicial:</label>
                <input type="month" id="filterMesInicial">
            </div>
        </div>
        
        <!-- Botones de Sucursales -->
        <div class="sucursal-buttons">
            <button class="sucursal-btn" onclick="filtrarPorSucursal('jalapa', this)">Jalapa</button>
            <button class="sucursal-btn" onclick="filtrarPorSucursal('poptun', this)">Poptún</button>
            <button class="sucursal-btn" onclick="filtrarPorSucursal('zacapa', this)">Zacapa</button>
            <button class="sucursal-btn" onclick="filtrarPorSucursal('santa elena', this)">Santa Elena</button>
            <button class="sucursal-btn" onclick="filtrarPorSucursal('pinula', this)">Pinula</button>
            <button class="sucursal-btn" onclick="filtrarPorSucursal('eskala', this)">Eskala</button>
        </div>

        <!-- Botón de Cierre de Mes -->
        <div class="global-controls">
            <div class="close-month">
                <button class="add-task-btn" onclick="realizarCierreMes()">Realizar Cierre de Mes</button>
            </div>
        </div>

        <div class="split-container" id="appContent" style="display: none;">
            <!-- Sección de Facturas -->
            <div class="section">
                <h2>Facturas</h2>
                <div class="table-controls">
                    <div class="filters">
                        <input type="text" id="searchInputFacturas" placeholder="Buscar facturas..." oninput="mostrarFacturas(selectedSucursal)">
                        <input type="date" id="filterFechaDesdeFacturas" onchange="mostrarFacturas(selectedSucursal)" placeholder="Fecha Desde">
                        <input type="date" id="filterFechaHastaFacturas" onchange="mostrarFacturas(selectedSucursal)" placeholder="Fecha Hasta">

                        <select id="sortOrderFacturas" onchange="mostrarFacturas(selectedSucursal)">
                            <option value="idAsc" selected>ID Ascendente</option>
                            <option value="idDesc">ID Descendente</option>
                            <option value="fechaAsc">Fecha Ascendente</option>
                            <option value="fechaDesc">Fecha Descendente</option>
                        </select>

                        <button id="resetFiltersFacturas" class="reset-filters-btn" onclick="resetFacturasFilters()">Resetear Filtros</button>
                    </div>
                    <div class="actions-buttons">
                        <button class="add-task-btn" onclick="abrirModalFactura()">Agregar Factura</button>
                    </div>
                </div>

                <div id="summaryFacturas" class="summary">
                    <p>Total General de Facturas: <strong id="totalFacturas">Q0.00</strong></p>
                </div>

                <div class="table-container">
                    <table id="facturaTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Proveedor</th>
                                <th>Número de Factura</th>
                                <th>Total (Q)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Facturas -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sección de Pagos -->
            <div class="section">
                <h2>Pagos</h2>

                <div class="table-controls">
                    <div class="filters">
                        <input type="text" id="searchInputPagos" placeholder="Buscar pagos..." oninput="mostrarPagos()">
                        <input type="month" id="filterMesPago" onchange="mostrarPagos()" placeholder="Mes Pago">
                        <input type="date" id="filterFechaDesdePagos" onchange="mostrarPagos()" placeholder="Fecha Desde">
                        <input type="date" id="filterFechaHastaPagos" onchange="mostrarPagos()" placeholder="Fecha Hasta">

                        <select id="sortOrderPagos" onchange="mostrarPagos()">
                            <option value="idAsc" selected>ID Ascendente</option>
                            <option value="idDesc">ID Descendente</option>
                            <option value="fechaAsc">Fecha Ascendente</option>
                            <option value="fechaDesc">Fecha Descendente</option>
                        </select>

                        <button id="resetFiltersPagos" class="reset-filters-btn" onclick="resetPagosFilters()">Resetear Filtros</button>
                    </div>
                    <div class="actions-buttons">
                        <button class="add-task-btn" onclick="abrirModalPago()">Registrar Pago</button>
                    </div>
                </div>

                <div id="summaryPagos" class="summary">
                    <p>Total Pagado: <strong id="totalPagado">Q0.00</strong></p>
                    <p>Total Pendiente: <strong id="totalPendiente">Q0.00</strong></p>
                    <p>Saldo: <strong id="saldo">Q0.00</strong></p>
                </div>

                <div class="table-container">
                    <table id="pagoTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Mes Pago</th>
                                <th>Fecha Pago</th>
                                <th>Número de Boleta</th>
                                <th>Total Boleta (Q)</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Pagos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modal Agregar/Editar Factura -->
        <div id="facturaModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModalFactura()">&times;</span>
                <h2 id="modalTitleFactura">Agregar Factura</h2>
                <form id="facturaForm">
                    <label for="cadenaDatosFactura">Cadena de Datos (opcional):</label>
                    <textarea id="cadenaDatosFactura" placeholder="Formato: Fecha,Proveedor,Número de Factura,Total(Q)
Ej: 2024-12-05,Proveedor ABC,FACT-001,1500.00"></textarea>
                    <p style="font-size:14px;color:#00695c;">Si ingresas la cadena, se usarán esos datos. Deja en blanco si quieres usar los campos manuales.</p>

                    <label for="fechaFactura">Fecha:</label>
                    <input type="date" id="fechaFactura">

                    <label for="proveedorFactura">Proveedor:</label>
                    <input type="text" id="proveedorFactura" placeholder="Ej: Proveedor XYZ">

                    <label for="noFactura">Número de Factura:</label>
                    <input type="text" id="noFactura" placeholder="Ej: FACT-001">

                    <label for="totalFactura">Total (Q):</label>
                    <input type="number" id="totalFactura" min="0" step="0.01">

                    <button type="submit">Guardar Factura</button>
                </form>
            </div>
        </div>

        <!-- Modal Registrar Pago -->
        <div id="pagoModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModalPago()">&times;</span>
                <h2 id="modalTitlePago">Registrar Pago</h2>
                <form id="pagoForm">
                    <label for="fechaPago">Fecha Pago:</label>
                    <input type="date" id="fechaPago" required>

                    <label for="boletaPago">Número de Boleta:</label>
                    <input type="text" id="boletaPago" placeholder="Ej: BOL-123" required>

                    <label for="precioTotalPagado">Total Boleta (Q):</label>
                    <input type="number" id="precioTotalPagado" min="0" step="0.01" required>

                    <button type="submit">Registrar Pago</button>
                </form>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            let facturas = JSON.parse(localStorage.getItem('facturas_pricesmart')) || [];
            let pagos = JSON.parse(localStorage.getItem('pagos_pricesmart')) || [];
            let lastIdFacturas = parseInt(localStorage.getItem('lastIdFacturas_pricesmart')) || 0;
            let lastIdPagos = parseInt(localStorage.getItem('lastIdPagos_pricesmart')) || 0;

            let selectedSucursal = '';
            let selectedMes = '';

            const selectSucursalMessage = document.getElementById('selectSucursalMessage');
            const appContent = document.getElementById('appContent');

            const facturaModal = document.getElementById('facturaModal');
            const modalTitleFactura = document.getElementById('modalTitleFactura');
            const facturaForm = document.getElementById('facturaForm');
            const cadenaDatosFacturaInput = document.getElementById('cadenaDatosFactura');
            const fechaFacturaInput = document.getElementById('fechaFactura');
            const proveedorFacturaInput = document.getElementById('proveedorFactura');
            const noFacturaInput = document.getElementById('noFactura');
            const totalFacturaInput = document.getElementById('totalFactura');

            const pagoModal = document.getElementById('pagoModal');
            const modalTitlePago = document.getElementById('modalTitlePago');
            const pagoForm = document.getElementById('pagoForm');
            const fechaPagoInput = document.getElementById('fechaPago');
            const boletaPagoInput = document.getElementById('boletaPago');
            const precioTotalPagadoInputPago = document.getElementById('precioTotalPagado');

            const filterMesInicial = document.getElementById('filterMesInicial');

            function resetFacturasFilters() {
                document.getElementById('searchInputFacturas').value = '';
                document.getElementById('filterFechaDesdeFacturas').value = '';
                document.getElementById('filterFechaHastaFacturas').value = '';
                document.getElementById('sortOrderFacturas').value = 'idAsc';
                mostrarFacturas(selectedSucursal);
            }

            function resetPagosFilters() {
                document.getElementById('searchInputPagos').value = '';
                document.getElementById('filterMesPago').value = '';
                document.getElementById('filterFechaDesdePagos').value = '';
                document.getElementById('filterFechaHastaPagos').value = '';
                document.getElementById('sortOrderPagos').value = 'idAsc';
                mostrarPagos();
            }

            function abrirModalFactura() {
                if (!selectedSucursal) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Selecciona una Sucursal primero.',
                    });
                    return;
                }
                facturaForm.reset();
                delete facturaForm.dataset.facturaId;
                modalTitleFactura.textContent = "Agregar Factura";
                facturaModal.style.display = "block";
            }

            function cerrarModalFactura() {
                facturaModal.style.display = "none";
            }

            function abrirModalPago() {
                if (!selectedSucursal) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Selecciona una Sucursal primero.',
                    });
                    return;
                }
                if (!selectedMes) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Selecciona un Mes Inicial antes de registrar un Pago.',
                    });
                    return;
                }

                pagoForm.reset();
                delete pagoForm.dataset.pagoId;
                modalTitlePago.textContent = "Registrar Pago";
                pagoModal.style.display = "block";
            }

            function cerrarModalPago() {
                pagoModal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == facturaModal) cerrarModalFactura();
                if (event.target == pagoModal) cerrarModalPago();
            }

            facturaForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const cadena = cadenaDatosFacturaInput.value.trim();
                let fecha = fechaFacturaInput.value;
                let proveedor = proveedorFacturaInput.value.trim();
                let noFact = noFacturaInput.value.trim();
                let total = parseFloat(totalFacturaInput.value) || 0;

                if (cadena !== '') {
                    // Usar cadena de datos
                    const campos = cadena.split(',').map(c => c.trim());
                    if (campos.length !== 4) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'La cadena de datos debe tener el formato: Fecha,Proveedor,Número de Factura,Total(Q)',
                        });
                        return;
                    }

                    fecha = campos[0];
                    proveedor = campos[1];
                    noFact = campos[2];
                    const totalCadena = parseFloat(campos[3]) || 0;

                    if (!fecha || !proveedor || !noFact || isNaN(totalCadena) || totalCadena <= 0) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Cadena de datos inválida. Verifica el formato y los valores.',
                        });
                        return;
                    }
                    total = totalCadena;
                } else {
                    // Usar campos manuales
                    if (!fecha || !proveedor || !noFact || total <= 0) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Por favor, completa todos los campos correctamente o utiliza la cadena de datos.',
                        });
                        return;
                    }
                }

                const isEditing = modalTitleFactura.textContent === "Editar Factura";
                if (isEditing) {
                    const facturaId = parseInt(facturaForm.dataset.facturaId);
                    const facturaIndex = facturas.findIndex(f => f.id === facturaId);
                    if (facturaIndex !== -1) {
                        facturas[facturaIndex].Fecha = fecha;
                        facturas[facturaIndex].Proveedor = proveedor;
                        facturas[facturaIndex].NoFactura = noFact;
                        facturas[facturaIndex].Total = total;
                        Swal.fire({
                            icon: 'success',
                            title: 'Actualizado',
                            text: 'Factura actualizada correctamente.',
                        });
                    }
                } else {
                    lastIdFacturas += 1;
                    const nuevaFactura = {
                        id: lastIdFacturas,
                        Sucursal: selectedSucursal,
                        Fecha: fecha,
                        Proveedor: proveedor,
                        NoFactura: noFact,
                        Total: total
                    };
                    facturas.push(nuevaFactura);
                    Swal.fire({
                        icon: 'success',
                        title: 'Agregada',
                        text: 'Factura agregada correctamente.',
                    });
                }

                localStorage.setItem('facturas_pricesmart', JSON.stringify(facturas));
                localStorage.setItem('lastIdFacturas_pricesmart', lastIdFacturas);

                mostrarFacturas(selectedSucursal);
                mostrarPagos();
                cerrarModalFactura();
            });

            pagoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const fecha = fechaPagoInput.value;
                const boleta = boletaPagoInput.value.trim();
                const precioTotalPagado = parseFloat(precioTotalPagadoInputPago.value) || 0;

                if (!fecha || !boleta || precioTotalPagado <= 0 || !selectedMes) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Completa todos los campos y asegúrate de haber seleccionado una Sucursal y un Mes Inicial.',
                    });
                    return;
                }

                const [year, month] = selectedMes.split('-').map(num => parseInt(num));
                const facturasMes = facturas.filter(f => {
                    const fDate = new Date(f.Fecha);
                    return f.Sucursal.toLowerCase() === selectedSucursal.toLowerCase() &&
                           fDate.getFullYear() === year &&
                           (fDate.getMonth() + 1) === month;
                });

                const totalFacturasMes = facturasMes.reduce((sum, f) => sum + f.Total, 0);
                const totalPagadoMes = pagos.filter(pg => pg.mes === selectedMes && pg.Sucursal.toLowerCase() === selectedSucursal.toLowerCase())
                                            .reduce((sum, pg) => sum + pg.precioTotalPagado, 0);

                const pendienteMes = (totalFacturasMes - totalPagadoMes) > 0 ? (totalFacturasMes - totalPagadoMes) : 0;
                const epsilon = 0.01;
                if (precioTotalPagado > (pendienteMes + epsilon)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: `El monto pagado excede el pendiente del Mes Seleccionado (Q${pendienteMes.toFixed(2)}).`,
                    });
                    return;
                }

                const isEditing = modalTitlePago.textContent === "Editar Pago";
                if (isEditing) {
                    const pagoId = parseInt(pagoForm.dataset.pagoId);
                    const pagoIndex = pagos.findIndex(p => p.id === pagoId);
                    if (pagoIndex !== -1) {
                        pagos[pagoIndex].fechaPago = fecha;
                        pagos[pagoIndex].boletaPago = boleta;
                        pagos[pagoIndex].precioTotalPagado = precioTotalPagado;
                        pagos[pagoIndex].mes = selectedMes;
                        pagos[pagoIndex].Sucursal = selectedSucursal;
                        Swal.fire({
                            icon: 'success',
                            title: 'Actualizado',
                            text: 'Pago actualizado correctamente.',
                        });
                    }
                } else {
                    lastIdPagos += 1;
                    const nuevoPago = {
                        id: lastIdPagos,
                        Sucursal: selectedSucursal,
                        fechaPago: fecha,
                        boletaPago: boleta,
                        precioTotalPagado: precioTotalPagado,
                        mes: selectedMes
                    };
                    pagos.push(nuevoPago);
                    Swal.fire({
                        icon: 'success',
                        title: 'Registrado',
                        text: 'Pago registrado correctamente.',
                    });
                }

                localStorage.setItem('pagos_pricesmart', JSON.stringify(pagos));
                localStorage.setItem('lastIdPagos_pricesmart', lastIdPagos);

                mostrarPagos();
                mostrarFacturas(selectedSucursal);
                cerrarModalPago();
            });

            function filtrarPorSucursal(sucursal, buttonSeleccionado) {
                selectedSucursal = sucursal.toLowerCase();
                const botones = document.querySelectorAll('.sucursal-btn');
                botones.forEach(btn => btn.classList.remove('active'));
                buttonSeleccionado.classList.add('active');
                selectSucursalMessage.style.display = "none";
                appContent.style.display = "flex";
                mostrarFacturas(selectedSucursal);
                mostrarPagos();
            }

            function mostrarFacturas(sucursalFiltrada) {
                let filtradas = [...facturas];

                if (sucursalFiltrada) {
                    filtradas = filtradas.filter(f => f.Sucursal.toLowerCase() === sucursalFiltrada.toLowerCase());
                }

                if (selectedMes) {
                    const [year, month] = selectedMes.split('-');
                    filtradas = filtradas.filter(f => {
                        const fDate = new Date(f.Fecha);
                        return fDate.getFullYear() === parseInt(year) && (fDate.getMonth() + 1) === parseInt(month);
                    });
                }

                const fechaDesde = document.getElementById('filterFechaDesdeFacturas').value;
                const fechaHasta = document.getElementById('filterFechaHastaFacturas').value;
                const searchTerm = (document.getElementById('searchInputFacturas').value || '').toLowerCase();
                const sort = document.getElementById('sortOrderFacturas').value;

                if (fechaDesde) {
                    filtradas = filtradas.filter(f => f.Fecha >= fechaDesde);
                }
                if (fechaHasta) {
                    filtradas = filtradas.filter(f => f.Fecha <= fechaHasta);
                }
                if (searchTerm) {
                    filtradas = filtradas.filter(f =>
                        f.id.toString().includes(searchTerm) ||
                        f.Proveedor.toLowerCase().includes(searchTerm) ||
                        f.NoFactura.toLowerCase().includes(searchTerm)
                    );
                }

                filtradas.sort((a, b) => {
                    if (sort === 'idAsc') return a.id - b.id;
                    if (sort === 'idDesc') return b.id - a.id;
                    if (sort === 'fechaAsc') return new Date(a.Fecha) - new Date(b.Fecha);
                    if (sort === 'fechaDesc') return new Date(b.Fecha) - new Date(a.Fecha);
                    return 0;
                });

                const facturaTableBody = document.querySelector('#facturaTable tbody');
                facturaTableBody.innerHTML = '';

                let total = 0;
                filtradas.forEach(f => {
                    const t = Number(f.Total) || 0;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${f.id}</td>
                        <td>${f.Fecha}</td>
                        <td>${f.Proveedor}</td>
                        <td>${f.NoFactura}</td>
                        <td>Q${t.toFixed(2)}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editarFactura(${f.id})">Editar</button>
                            <button class="action-btn delete-btn" onclick="eliminarFactura(${f.id})">Eliminar</button>
                        </td>
                    `;
                    facturaTableBody.appendChild(tr);
                    total += t;
                });

                document.getElementById('totalFacturas').textContent = `Q${total.toFixed(2)}`;
            }

            function mostrarPagos() {
                let pagosFiltrados = [...pagos];

                if (selectedSucursal) {
                    pagosFiltrados = pagosFiltrados.filter(pg => pg.Sucursal.toLowerCase() === selectedSucursal.toLowerCase());
                }

                const mesPagoVal = document.getElementById('filterMesPago').value;
                if (mesPagoVal) {
                    pagosFiltrados = pagosFiltrados.filter(pg => pg.mes === mesPagoVal);
                } else if (selectedMes) {
                    pagosFiltrados = pagosFiltrados.filter(pg => pg.mes === selectedMes);
                }

                const fechaDesde = document.getElementById('filterFechaDesdePagos').value;
                const fechaHasta = document.getElementById('filterFechaHastaPagos').value;
                const searchTerm = (document.getElementById('searchInputPagos').value || '').toLowerCase();
                const sort = document.getElementById('sortOrderPagos').value;

                if (fechaDesde) {
                    pagosFiltrados = pagosFiltrados.filter(pg => pg.fechaPago >= fechaDesde);
                }
                if (fechaHasta) {
                    pagosFiltrados = pagosFiltrados.filter(pg => pg.fechaPago <= fechaHasta);
                }
                if (searchTerm) {
                    pagosFiltrados = pagosFiltrados.filter(pg =>
                        pg.id.toString().includes(searchTerm) ||
                        pg.boletaPago.toLowerCase().includes(searchTerm)
                    );
                }

                pagosFiltrados.sort((a, b) => {
                    if (sort === 'idAsc') return a.id - b.id;
                    if (sort === 'idDesc') return b.id - a.id;
                    if (sort === 'fechaAsc') return new Date(a.fechaPago) - new Date(b.fechaPago);
                    if (sort === 'fechaDesc') return new Date(b.fechaPago) - new Date(a.fechaPago);
                    return 0;
                });

                const pagoTableBody = document.querySelector('#pagoTable tbody');
                pagoTableBody.innerHTML = '';

                let totalPagado = 0;
                pagosFiltrados.forEach(pg => {
                    const val = Number(pg.precioTotalPagado) || 0;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${pg.id}</td>
                        <td>${pg.mes}</td>
                        <td>${pg.fechaPago}</td>
                        <td>${pg.boletaPago}</td>
                        <td>Q${val.toFixed(2)}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editarPago(${pg.id})">Editar</button>
                            <button class="action-btn delete-btn" onclick="eliminarPago(${pg.id})">Eliminar</button>
                        </td>
                    `;
                    pagoTableBody.appendChild(tr);
                    totalPagado += val;
                });

                let totalFacturasMes = 0;
                if (selectedMes) {
                    const [year, month] = selectedMes.split('-').map(num => parseInt(num));
                    const facturasMes = facturas.filter(f => {
                        const fDate = new Date(f.Fecha);
                        return f.Sucursal.toLowerCase() === selectedSucursal.toLowerCase() &&
                               fDate.getFullYear() === year &&
                               (fDate.getMonth() + 1) === month;
                    });
                    totalFacturasMes = facturasMes.reduce((sum, f) => sum + f.Total, 0);
                }

                const saldo = totalPagado - totalFacturasMes;
                const totalPend = (totalFacturasMes - totalPagado) > 0 ? (totalFacturasMes - totalPagado) : 0;

                document.getElementById('totalPagado').textContent = `Q${totalPagado.toFixed(2)}`;
                document.getElementById('totalPendiente').textContent = `Q${totalPend.toFixed(2)}`;
                document.getElementById('saldo').textContent = saldo > 0 ? `Q${saldo.toFixed(2)}` : 'Q0.00';

                document.getElementById('saldo').style.color = saldo > 0 ? 'green' : 'red';
                document.getElementById('totalPendiente').style.color = totalPend > 0 ? 'red' : 'green';
            }

            function editarFactura(id) {
                const f = facturas.find(f => f.id === id);
                if (f) {
                    modalTitleFactura.textContent = "Editar Factura";
                    cadenaDatosFacturaInput.value = '';
                    fechaFacturaInput.value = f.Fecha;
                    proveedorFacturaInput.value = f.Proveedor;
                    noFacturaInput.value = f.NoFactura;
                    totalFacturaInput.value = f.Total.toFixed(2);
                    facturaForm.dataset.facturaId = f.id;
                    facturaModal.style.display = "block";
                }
            }

            function eliminarFactura(id) {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "Esto eliminará la Factura y los pagos asociados a ese mes.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const factura = facturas.find(f => f.id === id);
                        const mesFactura = getMesDeFactura(factura);
                        facturas = facturas.filter(f => f.id !== id);
                        pagos = pagos.filter(pg => !(pg.mes === mesFactura && pg.Sucursal.toLowerCase() === factura.Sucursal.toLowerCase()));
                        localStorage.setItem('facturas_pricesmart', JSON.stringify(facturas));
                        localStorage.setItem('pagos_pricesmart', JSON.stringify(pagos));
                        localStorage.setItem('lastIdFacturas_pricesmart', lastIdFacturas);
                        localStorage.setItem('lastIdPagos_pricesmart', lastIdPagos);
                        mostrarFacturas(selectedSucursal);
                        mostrarPagos();
                        Swal.fire(
                            'Eliminado!',
                            'La factura y sus pagos asociados han sido eliminados.',
                            'success'
                        )
                    }
                })
            }

            function getMesDeFactura(factura) {
                if (!factura || !factura.Fecha) return '';
                const [year, month] = factura.Fecha.split('-');
                return `${year}-${month}`;
            }

            function editarPago(id) {
                const pg = pagos.find(pg => pg.id === id);
                if (pg) {
                    modalTitlePago.textContent = "Editar Pago";
                    fechaPagoInput.value = pg.fechaPago;
                    boletaPagoInput.value = pg.boletaPago;
                    precioTotalPagadoInputPago.value = pg.precioTotalPagado.toFixed(2);
                    pagoForm.dataset.pagoId = pg.id;
                    pagoModal.style.display = "block";
                }
            }

            function eliminarPago(id) {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "No podrás revertir esto!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        pagos = pagos.filter(pg => pg.id !== id);
                        localStorage.setItem('pagos_pricesmart', JSON.stringify(pagos));
                        mostrarPagos();
                        mostrarFacturas(selectedSucursal);
                        Swal.fire(
                            'Eliminado!',
                            'El pago ha sido eliminado.',
                            'success'
                        )
                    }
                })
            }

            filterMesInicial.addEventListener('change', function() {
                const mesSel = filterMesInicial.value;
                if (mesSel) {
                    selectedMes = mesSel;
                    if (selectedSucursal !== '') {
                        mostrarFacturas(selectedSucursal);
                        mostrarPagos();
                    }
                } else {
                    selectedMes = '';
                    if (selectedSucursal !== '') {
                        mostrarFacturas(selectedSucursal);
                        mostrarPagos();
                    }
                }
            });

            function realizarCierreMes() {
                if (!selectedSucursal) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Selecciona una Sucursal antes de realizar el Cierre de Mes.',
                    });
                    return;
                }
                const mesSeleccionado = filterMesInicial.value;
                if (!mesSeleccionado) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Selecciona un Mes antes de realizar el Cierre de Mes.',
                    });
                    return;
                }
                // Redireccionar a 'cierrepricesmart.html'
                window.location.href = 'cierrepricesmart.html';
            }

            window.onload = function() {
                mostrarFacturas(selectedSucursal);
                mostrarPagos();
            }
        </script>
    </div>
</body>
</html>
